#parse("/common/util.vm")
<html lang="zh_CN">
<head>
    #parse("/client/component/init/responsive_lib.vm")
    #parse("/client/component/init/init_lib.vm")
    #parse("/client/component/init/weui_lib.vm")
    #parse("/client/component/init/location_lib.vm")
    <link rel="stylesheet" type="text/css" href="${path.concat('/material/client/css/style.css')}">
    <title>智慧新风</title>
</head>
<body ontouchstart>
<div class="article">
    <div class="bd" style="padding-bottom: 50px;">
        <section>
            <img src="${path.concat('/material/client/image/newfj/newfj_01.jpg')}"/>
        </section>
        <section>
            <img src="${path.concat('/material/client/image/newfj/newfj_02.jpg')}"/>
        </section>
        <section>
            <img src="${path.concat('/material/client/image/newfj/newfj_03.jpg')}"/>
        </section>
        <section>
            <img src="${path.concat('/material/client/image/newfj/newfj_04.jpg')}"/>
        </section>
        <section>
            <img src="${path.concat('/material/client/image/newfj/newfj_05.jpg')}"/>
        </section>
        <section>
            <img src="${path.concat('/material/client/image/newfj/newfj_06.jpg')}"/>
        </section>
        <section>
            <img src="${path.concat('/material/client/image/newfj/newfj_07.jpg')}"/>
        </section>
        <section>
            <img src="${path.concat('/material/client/image/newfj/newfj_08.jpg')}"/>
        </section>
        <section>
            <img src="${path.concat('/material/client/image/newfj/newfj_09.jpg')}"/>
        </section>
        <section>
            <img src="${path.concat('/material/client/image/newfj/newfj_10.jpg')}"/>
        </section>
    </div>
</div>
<footer>
    <div class="upper">
        <div class="price">
            <div id="agent_price" class="price">
                <div class="pre_price">￥${goods.primePrice}</div>
                <div class="now_price">${goods.sharePrice}/<span class="pieces">台</span><span
                        class="postStyle">(包邮)</span></div>
            </div>
        </div>
        <div class="name">
            <p>智慧新风</p>
        </div>
    </div>
    <div class="under">
        <div class="num">
            <p>数量</p>

            <div class="number_choose">
                <button id="min_btn" class="min">—</button>
                <input id="goods_num" class="num_box" type="text" value="1" readonly="true"/>
                <button id="add_btn" class="add">+</button>
            </div>
        </div>
        <div class="purchase">
            <button id="purchase">立即购买</button>
        </div>
    </div>
</footer>
<div id="actionSheet_wrap">
    <div class="weui_mask_transition" id="number_div" style="display: none;"></div>
    <div class="weui_actionsheet" id="weui_actionsheet">
        <div class="weui_actionsheet_menu">
            <div class="menu_title">
                <h3>订单信息</h3>
            </div>
            <div class="address_area">
                <div class="address_information">
                    <div class="address_title">
                        <div class="address_icon">
                            <img class="icon" src="${path.concat('/material/client/image/address_icon.jpg')}"/>
                        </div>
                        <p>收货地址</p>
                    </div>
                    <div class="weui_cells">
                        <div class="weui_cell">
                            <div class="weui_cell_hd">
                                <label class="weui_label">姓名</label>
                            </div>
                            <div class="weui_cell_bd weui_cell_primary">
                                <input id="customer_name" name="customerName" class="weui_input" type="text"
                                       placeholder="请填写收货人姓名" autocomplete="off"/>
                            </div>
                        </div>
                        <div class="weui_cell">
                            <div class="weui_cell_hd">
                                <label class="weui_label">手机号</label>
                            </div>
                            <div class="weui_cell_bd weui_cell_primary">
                                <input id="customer_phone" name="phone" class="weui_input" type="tel"
                                       placeholder="请填写手机号" autocomplete="off"/>
                            </div>
                        </div>

                        <div class="weui_cells">
                            <div class="weui_cell">
                                <div class="weui_cell_hd">
                                    <label class="weui_label">地区</label>
                                </div>
                                <div class="weui_cell_bd weui_cell_primary">
                                    <div id="province">
                                        <select id="prov" class="prov"></select>
                                        <select id="city" class="city" disabled="disabled"
                                                style="display:none"></select>
                                        <select id="dist" class="dist" disabled="disabled"
                                                style="display:none"></select>
                                    </div>
                                </div>
                            </div>
                            <div class="weui_cell">
                                <div class="weui_cell_hd">
                                    <label class="weui_label">地址</label>
                                </div>
                                <div class="weui_cell_bd weui_cell_primary">
                                    <input id="customer_address" name="address" class="weui_input" type="text"
                                           placeholder="请填写详细地址"
                                           autocomplete="off"/>
                                </div>
                            </div>
                        </div>

                        <div class="weui_cell postcode">
                            <div class="weui_cell_hd">
                                <label class="weui_label">邮政编码</label>
                            </div>
                            <div class="weui_cell_bd weui_cell_primary">
                                <input id="postcode" name="postcode" class="weui_input" type="tel" placeholder="请填写邮政编码"
                                       autocomplete="off"/>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="weui_cell id">
                <div class="id_icon">
                    <img class="icon" src="${path.concat('/material/client/image/id_icon.jpg')}"/>
                </div>
                <div class="agent_id">
                    <table>
                        <tr>
                            <td class="hd">
                                <label class="id_label">优惠码</label>
                            </td>
                            <td class="bd">
                                <input id="client_id" class="id_input" type="text" placeholder="可输入优惠码"
                                       value="$!{client}" disabled/>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            <div class="confirm_area">
                <div class="total_info">
                ##                    <div class="total_num">
##                        <p>共
##
##                        <p id="total_num">1</p>台
##                        </p>
##                    </div>
##                    <div class="total_money">
##                        <p class="sum">应付总额：</p>
##
##                        <p id="total_price" class="sum_price">10000元</p>
##                    </div>
                </div>
                <div class="to_pay">
                    <button id="confirm" class="weui_btn weui_btn_disabled weui_btn_default" disabled="disabled">支付
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="weui_dialog_alert" id="dialog" style="display: none;">
    <div class="weui_mask"></div>
    <div class="weui_dialog">
        <div class="weui_dialog_hd"><strong class="weui_dialog_title">消息</strong></div>
        <div class="weui_dialog_bd"></div>
        <div class="weui_dialog_ft">
            <a href="javascript:;" class="weui_btn_dialog primary">确定</a>
        </div>
    </div>
</div>
</body>
    #parse("/client/component/wechat/wechat_config.vm")
<script type="text/javascript" src="${path.concat('/material/client/js/purchase.js')}"></script>
<script>
    $(function () {
        var script = document.createElement('script');
        script.type = 'text/javascript';
        script.src = "${path.concat('/plugins/pingxx/pingpp_one.js')}";
        document.body.appendChild(script);

        $(document).on('pingpp_one_ready', function () {
            $('#confirm').click(function () {
                //检查优惠码是否正确
                pay();
            });
        });
    });

    var clientId = "${client}";
    var openId = '$!{openId}';

    function pay() {
        var goodsId = "${goodsId}";
        var url = "${path.concat('/goods/')}" + "purchase/" + goodsId;
        var clientId = $("#client_id").val();
        var goodsNum = $('#goods_num').val();
        var customerName = $('#customer_name').val();
        var phone = $('#customer_phone').val();
        var address;

        if ($("#dist").is(":hidden")) {
            if ($("#city").is(":hidden")) {
                address = $("#prov").val() + $("#customer_address").val();
            } else {
                address = $("#prov").val() + $("#city").val() + $("#customer_address").val();
            }
        } else {
            address = $("#prov").val() + $("#city").val() + $("#dist").val() + $("#customer_address").val();
        }

        var param = {
            clientId: clientId,
            goodsQuantity: goodsNum,
            consumerName: customerName,
            consumerPhone: phone,
            consumerAddress: address,
            wechat: openId
        };
        $.post(url, param, function (result) {
            if (result.responseCode == "RESPONSE_OK") {
                var data = result.data;
                pingpp_one.init({
                    app_id: "app_DazjbTLybjHGbv9O",
                    amount: data.totalFee,
                    channel: ['wx_pub'],
                    charge_url: "${path.concat('/payment/consumer/create')}",
                    charge_param: {order_id: data.orderId},
                    open_id: '${openId}',
                    debug: true
                }, function (result) {
                    //debug 模式下获取 charge_url 的返回结果
                    if (result.debug && result.chargeUrlOutput) {
                        console.log(result.chargeUrlOutput);
                    }
                    if (!result.status) {
                        //处理错误
                        $("#fail_dialog").show();
                    }
                    else {
                        //debug 模式下调用 charge_url 后会暂停，可以调用 pingpp_one.resume 方法继续执行
                        if (result.debug && !result.wxSuccess) {
                            if (confirm('当前为 debug 模式，是否继续支付？')) {
                                pingpp_one.resume();
                            }
                        }
                        //若微信公众号渠道需要使用壹收款的支付成功页面，则在这里进行成功回调，
                        //调用 pingpp_one.success 方法，你也可以自己定义回调函数
                        //其他渠道的处理方法请见第 2 节
                        else {
                            $('.unslider-fade').hide();
                            $('.unslider-nav').hide();
                            $('.weui_actionsheet').hide();
                            $('.weui_mask_transition').hide();
                            pingpp_one.success(function (result) {
                                if (!result.status) {
                                    $("#fail_dialog").show();
                                }
                            }, function () {
                                //这里处理支付成功页面点击“继续购物”按钮触发的方法，
                                //例如：若你需要点击“继续购物”按钮跳转到你的购买页，
                                //则在该方法内写入 window.location.href = "你的购买页面 url"
                                window.location.href = "/goods/" + goodsId + "/purchase?client=" + clientId;
                            });
                        }
                    }
                });
            }
        });
    }
</script>
</html>